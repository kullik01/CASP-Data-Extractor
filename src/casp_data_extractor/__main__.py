import csv
import time

import requests
import io
import pandas as pd
import enum
import re
from typing import Dict, List, Optional

class Metrics(enum.IntEnum):
  """Enum for CASP metrics."""
  N1 = 0
  N2 = 1
  DIST = 2
  N = 3
  RMSD = 4
  GDT_TS = 5
  LGA_S3 = 6
  LGA_Q = 7


class Model:
  """Class for representing a CASP model."""
  def __init__(self, metrics: Dict[Metrics, float]):
    self.metrics = metrics

  def __repr__(self):
    return f"Model({ {m.name: v for m, v in self.metrics.items()} })"


class Group:
  """Class for representing a CASP group."""
  def __init__(self, models: Dict[str, List[Model]]):
    self.models = models

  def __repr__(self):
    return f"Group({len(self.models)} models)"


class Casp:
  """Class for representing a CASP dataset."""
  def __init__(self, name: str, data_url: str, targets: List[str], groups: Dict[str, Group]):
    self.name = name
    self.data_url = data_url
    self.targets = targets
    self.groups = groups
    self.winner = None
    self.metric = list(Metrics)

  def calculate_global_metrics(self) -> dict[Metrics, float]:
    """Calculate mean values for all metrics across all groups."""
    metric_sums = {m: 0.0 for m in Metrics}
    metric_counts = {m: 0 for m in Metrics}

    for group in self.groups.values():
      for model_list in group.models.values():
        for model in model_list:
          for metric, value in model.metrics.items():
            metric_sums[metric] += value
            metric_counts[metric] += 1

    return {
      metric: metric_sums[metric] / metric_counts[metric]
      for metric in Metrics
      if metric_counts[metric] > 0
    }

  def calculate_group_metrics(self, min_models: int = 0) -> dict[str, dict[Metrics, float]]:
    """Calculate mean metrics for groups with at least min_models."""
    group_metrics = {}

    for group_id, group in self.groups.items():
      # Calculate total models in group
      total_models = sum(len(models) for models in group.models.values())

      if total_models < min_models:
        continue  # Skip groups below threshold

      group_sums = {m: 0.0 for m in Metrics}
      group_counts = {m: 0 for m in Metrics}

      for model_list in group.models.values():
        for model in model_list:
          for metric, value in model.metrics.items():
            group_sums[metric] += value
            group_counts[metric] += 1

      group_metrics[group_id] = {
        metric: group_sums[metric] / group_counts[metric]
        for metric in Metrics
        if group_counts[metric] > 0
      }
      group_metrics[group_id]['model_count'] = total_models  # Add count to results

    return group_metrics

  def __repr__(self):
    return f"CASP({self.name}, {len(self.groups)} groups)"


def parse_summary_content(content: str) -> pd.DataFrame:
  """Parse summary file content into DataFrame with cleaned columns."""
  try:
    df = pd.read_csv(
      io.StringIO(content),
      sep=r'\s{2,}',
      engine='python',
      header=0,
      dtype={
        'N1': 'int32',
        'N2': 'int32',
        'DIST': 'float32',
        'N': 'int32',
        'RMSD': 'float32',
        'GDT_TS': 'float32',
        'LGA_S3': 'float32',
        'LGA_Q': 'float32'
      }
    )
    # Clean and validate names
    # df['NAME'] = df['NAME'].str.replace(r':SUMMARY\(GDT\).lga$', '', regex=True)
    # df = df[~df['NAME'].str.contains('SUMMARY')]  # Remove header rows
    #return df.dropna()
    df['NAME'] = df['NAME'].str.replace(r':SUMMARY\(GDT\).lga$', '', regex=True)
    return df
  except Exception as e:
    print(f"Parsing error: {str(e)}")
    return pd.DataFrame()


def extract_group_id(name: str) -> Optional[str]:
  """Extract group ID from model name using regex."""
  match = re.search(r'TS(\d+)_', name)
  return match.group(1) if match else None


def build_casp_structure(name: str, targets: List[str], base_url: str) -> Casp:
  """Build Casp structure from all target summary files."""
  casp = Casp(
    name=name,
    data_url=base_url,
    targets=targets,
    groups={}
  )

  for target in targets:
    if name == "CASP9" or name == "CASP8":
      url = f"{base_url}{target}.SUMMARY.lga_sda_4.txt"
    else:
      url = f"{base_url}{target}.SUMMARY.lga_sda.txt"

    try:
      response = requests.get(url)
      response.raise_for_status()
      df = parse_summary_content(response.text)

      for _, row in df.iterrows():
        model_name = row['NAME']
        group_id = extract_group_id(model_name)

        if not group_id:
          continue

        # Create metrics dictionary
        metrics = {
          Metrics.N1: row['N1'],
          Metrics.N2: row['N2'],
          Metrics.DIST: row['DIST'],
          Metrics.N: row['N'],
          Metrics.RMSD: row['RMSD'],
          Metrics.GDT_TS: row['GDT_TS'],
          Metrics.LGA_S3: row['LGA_S3'],
          Metrics.LGA_Q: row['LGA_Q']
        }

        # Create or update group
        if group_id not in casp.groups:
          casp.groups[group_id] = Group(models={})

        # Add model to group
        if model_name not in casp.groups[group_id].models:
          casp.groups[group_id].models[model_name] = []
        casp.groups[group_id].models[model_name].append(Model(metrics))

    except Exception as e:
      print(f"Error processing {target}: {str(e)}")

  return casp


def extract_casp_winner(name, data_url, target_list, min_models_count) -> Optional[tuple]:
  casp_data = build_casp_structure(
    name=name,
    targets=target_list,
    base_url=data_url
  )
  for tmp_key in casp_data.groups.keys():
    print(f"Group {tmp_key} has {len(casp_data.groups[tmp_key].models)} models.")
  # Get global means across all groups/models
  global_means = casp_data.calculate_global_metrics()
  print(f"Global GDT_TS mean: {global_means[Metrics.GDT_TS]:.2f}")
  print(f"Global RMSD mean: {global_means[Metrics.RMSD]:.2f}")

  group_means = casp_data.calculate_group_metrics(min_models=min_models_count)  # Only groups with â‰¥5 models

  # Find group with lowest RMSD among qualified groups
  if group_means:
    min_group = min(
      group_means.items(),
      key=lambda x: x[1].get(Metrics.RMSD, float('inf'))
    )
    print(f"Best group: {min_group[0]}")
    print(f"RMSD: {min_group[1][Metrics.RMSD]:.2f}")
    print(f"Model count: {min_group[1]['model_count']}")
    return min_group[0], min_group[1][Metrics.GDT_TS], min_group[1][Metrics.RMSD]
  else:
    print("No groups meet the minimum model threshold")
    return None


if __name__ == '__main__':
  start_time = time.time()

  tmp_casp_winners = {}
  tmp_all_casps_targets = {
    # Key: CASPXX; Value: tuple(list of target names, min no. of models for winner selection
    "CASP14": (
      "https://predictioncenter.org/download_area/CASP14/results/sda/",
      [
      "T1024-D1",
      "T1024-D2",
      "T1024",
      "T1025-D1",
      "T1026-D1",
      "T1027-D1",
      "T1028-D1",
      "T1029-D1",
      "T1030-D1",
      "T1030-D2",
      "T1030",
      "T1031-D1",
      "T1032-D1",
      "T1033-D1",
      "T1034-D1",
      "T1035-D1",
      "T1036s1-D1",
      "T1037-D1",
      "T1038-D1",
      "T1038-D2",
      "T1038",
      "T1039-D1",
      "T1040-D1",
      "T1041-D1",
      "T1042-D1",
      "T1043-D1",
      "T1045s1-D1",
      "T1045s2-D1",
      "T1046s1-D1",
      "T1046s2-D1",
      "T1047s1-D1",
      "T1047s2-D1",
      "T1047s2-D2",
      "T1047s2-D3",
      "T1047s2",
      "T1048",
      "T1049-D1",
      "T1050-D1",
      "T1050-D2",
      "T1050-D3",
      "T1050",
      "T1052-D1",
      "T1052-D2",
      "T1052-D3",
      "T1052",
      "T1053-D1",
      "T1053-D2",
      "T1053",
      "T1054-D1",
      "T1054",
      "T1055-D1",
      "T1056-D1",
      "T1057-D1",
      "T1058-D1",
      "T1058-D2",
      "T1058",
      "T1060s2-D1",
      "T1060s3-D1",
      "T1061-D1",
      "T1061-D2",
      "T1061-D3",
      "T1061",
      "T1062",
      "T1064-D1",
      "T1065s1-D1",
      "T1065s2-D1",
      "T1067-D1",
      "T1068-D1",
      "T1070-D1",
      "T1070-D2",
      "T1070-D3",
      "T1070-D4",
      "T1070",
      "T1072s1",
      "T1073-D1",
      "T1074-D1",
      "T1076-D1",
      "T1078-D1",
      "T1079-D1",
      "T1080-D1",
      "T1082-D1",
      "T1083-D1",
      "T1084-D1",
      "T1085-D1",
      "T1085-D2",
      "T1085-D3",
      "T1085",
      "T1086-D1",
      "T1086-D2",
      "T1086",
      "T1087-D1",
      "T1088-D1",
      "T1089-D1",
      "T1090-D1",
      "T1091-D1",
      "T1091-D2",
      "T1091-D3",
      "T1091-D4",
      "T1091",
      "T1092-D1",
      "T1092-D2",
      "T1092",
      "T1093-D1",
      "T1093-D2",
      "T1093-D3",
      "T1093",
      "T1094-D1",
      "T1094-D2",
      "T1094",
      "T1095-D1",
      "T1095",
      "T1096-D1",
      "T1096-D2",
      "T1096",
      "T1098-D1",
      "T1098-D2",
      "T1098",
      "T1099-D1",
      "T1100-D1",
      "T1100-D2",
      "T1100",
      "T1101-D1",
      "T1101-D2",
      "T1101",
      "T1104-D1"
    ],
      600
    ),
    "CASP13": (
      "https://predictioncenter.org/download_area/CASP13/results/sda/",
      [
       "T0949-D1",
       "T0950-D1",
       "T0950",
       "T0951-D1",
       "T0953s1-D1",
       "T0953s2-D1",
       "T0953s2-D2",
       "T0953s2-D3",
       "T0953s2-D23",
       "T0953s2",
       "T0954-D1",
       "T0955-D1",
       "T0957s1-D1",
       "T0957s1-D2",
       "T0957s1",
       "T0957s2-D1",
       "T0957s2",
       "T0958-D1",
       "T0959-D1",
       "T0960-D1",
       "T0960-D2",
       "T0960-D3",
       "T0960-D4",
       "T0960-D5",
       "T0960",
       "T0961-D1",
       "T0962-D1",
       "T0963-D1",
       "T0963-D2",
       "T0963-D3",
       "T0963-D4",
       "T0963-D5",
       "T0963",
       "T0964-D1",
       "T0965-D1",
       "T0966-D1",
       "T0967-D1",
       "T0968s1-D1",
       "T0968s2-D1",
       "T0969-D1",
       "T0970-D1",
       "T0971-D1",
       "T0973-D1",
       "T0974s1-D1",
       "T0974s2-D1",
       "T0975-D1",
       "T0976-D1",
       "T0976-D2",
       "T0976",
       "T0977-D1",
       "T0977-D2",
       "T0977",
       "T0978-D1",
       "T0979-D1",
       "T0980s1-D1",
       "T0980s2-D1",
       "T0981-D1",
       "T0981-D2",
       "T0981-D3",
       "T0981-D4",
       "T0981-D5",
       "T0981",
       "T0982-D1",
       "T0982-D2",
       "T0982",
       "T0983-D1",
       "T0984-D1",
       "T0984-D2",
       "T0985-D1",
       "T0986s1-D1",
       "T0986s2-D1",
       "T0987-D1",
       "T0987-D2",
       "T0987",
       "T0989-D1",
       "T0989-D2",
       "T0989",
       "T0990-D1",
       "T0990-D2",
       "T0990-D3",
       "T0990",
       "T0991-D1",
       "T0992-D1",
       "T0993s1-D1",
       "T0993s2-D1",
       "T0995-D1",
       "T0996-D1",
       "T0996-D2",
       "T0996-D3",
       "T0996-D4",
       "T0996-D5",
       "T0996-D6",
       "T0996-D7",
       "T0996",
       "T0997-D1",
       "T0998-D1",
       "T0999-D1",
       "T0999-D2",
       "T0999-D3",
       "T0999-D4",
       "T0999-D5",
       "T1000-D1",
       "T1000-D2",
       "T1000",
       "T1001-D1",
       "T1002-D1",
       "T1002-D2",
       "T1002-D3",
       "T1002",
       "T1003-D1",
       "T1004-D1",
       "T1004-D2",
       "T1004-D3",
       "T1004",
       "T1005-D1",
       "T1006-D1",
       "T1008-D1",
       "T1009-D1",
       "T1010-D1",
       "T1011-D1",
       "T1011-D2",
       "T1011",
       "T1013-D1",
       "T1014-D1",
       "T1014-D2",
       "T1014",
       "T1015s1-D1",
       "T1015s2-D1",
       "T1016-D1",
       "T1017s1-D1",
       "T1017s2-D1",
       "T1018-D1",
       "T1019s1-D1",
       "T1019s2-D1",
       "T1020-D1",
       "T1021s1-D1",
       "T1021s2-D1",
       "T1021s3-D1",
       "T1021s3-D2",
       "T1021s3",
       "T1022s1-D1",
       "T1022s1-D2",
       "T1022s1",
       "T1022s2-D1"
    ],
      600
    ),
    "CASP12": (
      "https://predictioncenter.org/download_area/CASP12/results_LGA_sda/",
      [
        "T0859-D1",
        "T0859",
        "T0860-D1",
        "T0860",
        "T0861-D1",
        "T0861",
        "T0862-D1",
        "T0862",
        "T0863-D1",
        "T0863-D2",
        "T0863",
        "T0864-D1",
        "T0864",
        "T0865-D1",
        "T0865",
        "T0866-D1",
        "T0866",
        "T0867-D1",
        "T0867",
        "T0868-D1",
        "T0868",
        "T0869-D1",
        "T0869",
        "T0870-D1",
        "T0870",
        "T0871-D1",
        "T0871",
        "T0872-D1",
        "T0872",
        "T0873-D1",
        "T0873",
        "T0874-D1",
        "T0874",
        "T0875-D1",
        "T0875",
        "T0876-D1",
        "T0876",
        "T0877-D1",
        "T0877",
        "T0878-D1",
        "T0878",
        "T0879-D1",
        "T0879",
        "T0880-D1",
        "T0880-D2",
        "T0880",
        "T0881-D1",
        "T0881",
        "T0882-D1",
        "T0882",
        "T0883-D1",
        "T0883",
        "T0884-D1",
        "T0884",
        "T0885-D1",
        "T0885",
        "T0886-D1",
        "T0886-D2",
        "T0886",
        "T0887-D1",
        "T0887-D9",
        "T0887",
        "T0888-D1",
        "T0888",
        "T0889-D1",
        "T0889",
        "T0890-D1",
        "T0890-D2",
        "T0890",
        "T0891-D1",
        "T0891",
        "T0892-D1",
        "T0892-D2",
        "T0892",
        "T0893-D1",
        "T0893-D2",
        "T0893",
        "T0894-D1",
        "T0894-D2",
        "T0894",
        "T0895-D1",
        "T0895",
        "T0896-D1",
        "T0896-D2",
        "T0896-D3",
        "T0896",
        "T0897-D1",
        "T0897-D2",
        "T0897",
        "T0898-D1",
        "T0898-D2",
        "T0898",
        "T0899-D1",
        "T0899-D2",
        "T0899",
        "T0900-D1",
        "T0900",
        "T0901-D1",
        "T0901-D2",
        "T0901",
        "T0902-D1",
        "T0902",
        "T0903-D1",
        "T0903",
        "T0904-D1",
        "T0904",
        "T0905-D1",
        "T0905-D2",
        "T0905",
        "T0906-D1",
        "T0906",
        "T0907-D1",
        "T0907-D2",
        "T0907-D3",
        "T0907",
        "T0909-D1",
        "T0909",
        "T0910-D1",
        "T0910",
        "T0911-D1",
        "T0911",
        "T0912-D1",
        "T0912-D2",
        "T0912-D3",
        "T0912",
        "T0913-D1",
        "T0913",
        "T0914-D1",
        "T0914-D2",
        "T0914",
        "T0915-D1",
        "T0915",
        "T0917-D1",
        "T0917",
        "T0918-D1",
        "T0918-D2",
        "T0918-D3",
        "T0918",
        "T0920-D1",
        "T0920-D2",
        "T0920",
        "T0921-D1",
        "T0921",
        "T0922-D1",
        "T0922",
        "T0923-D1",
        "T0923",
        "T0928-D1",
        "T0928",
        "T0929",
        "T0930",
        "T0931",
        "T0932",
        "T0933",
        "T0934",
        "T0941-D1",
        "T0941",
        "T0942-D1",
        "T0942-D2",
        "T0942",
        "T0943-D1",
        "T0943-D2",
        "T0943",
        "T0944-D1",
        "T0944",
        "T0945-D1",
        "T0945",
        "T0946-D1",
        "T0946-D2",
        "T0946",
        "T0947-D1",
        "T0947",
        "T0948-D1",
        "T0948"
      ],
      600
    ),
    "CASP11": (
      "https://predictioncenter.org/download_area/CASP11/results_LGA_sda/",
      [
        "T0759-D1",
        "T0759-D2",
        "T0759",
        "T0760-D1",
        "T0760",
        "T0761-D1",
        "T0761-D2",
        "T0761",
        "T0762-D1",
        "T0762",
        "T0763-D1",
        "T0763",
        "T0764-D1",
        "T0764",
        "T0765-D1",
        "T0765",
        "T0766-D1",
        "T0766",
        "T0767-D1",
        "T0767-D2",
        "T0767",
        "T0768-D1",
        "T0768",
        "T0769-D1",
        "T0769",
        "T0770-D1",
        "T0770",
        "T0771-D1",
        "T0771",
        "T0772-D1",
        "T0772",
        "T0773-D1",
        "T0773",
        "T0774-D1",
        "T0774",
        "T0775-D1",
        "T0775-D2",
        "T0775-D3",
        "T0775-D4",
        "T0775-D5",
        "T0775-D6",
        "T0775",
        "T0776-D1",
        "T0776",
        "T0777-D1",
        "T0777",
        "T0780-D1",
        "T0780-D2",
        "T0780",
        "T0781-D1",
        "T0781-D2",
        "T0781",
        "T0782-D1",
        "T0782",
        "T0783-D1",
        "T0783-D2",
        "T0783",
        "T0784-D1",
        "T0784",
        "T0785-D1",
        "T0785",
        "T0786-D1",
        "T0786",
        "T0787",
        "T0788",
        "T0789-D1",
        "T0789-D2",
        "T0789",
        "T0790-D1",
        "T0790-D2",
        "T0790",
        "T0791-D1",
        "T0791-D2",
        "T0791",
        "T0792-D1",
        "T0792",
        "T0793-D1",
        "T0793-D2",
        "T0793-D3",
        "T0793-D4",
        "T0793-D5",
        "T0793",
        "T0794-D1",
        "T0794-D2",
        "T0794",
        "T0795-D1",
        "T0795",
        "T0796-D1",
        "T0796",
        "T0797",
        "T0798",
        "T0799-D1",
        "T0799-D2",
        "T0799-D3",
        "T0799-D4",
        "T0799",
        "T0800-D1",
        "T0800",
        "T0801-D1",
        "T0801",
        "T0802-D1",
        "T0802",
        "T0803-D1",
        "T0803",
        "T0804-D1",
        "T0804-D2",
        "T0804",
        "T0805-D1",
        "T0805",
        "T0806-D1",
        "T0806",
        "T0807-D1",
        "T0807",
        "T0808-D1",
        "T0808-D2",
        "T0808",
        "T0810-D1",
        "T0810-D2",
        "T0810",
        "T0811-D1",
        "T0811",
        "T0812-D1",
        "T0812",
        "T0813-D1",
        "T0813",
        "T0814-D1",
        "T0814-D2",
        "T0814-D3",
        "T0814",
        "T0815-D1",
        "T0815",
        "T0816-D1",
        "T0816",
        "T0817-D1",
        "T0817-D2",
        "T0817",
        "T0818-D1",
        "T0818",
        "T0819-D1",
        "T0819",
        "T0820-D1",
        "T0820",
        "T0821-D1",
        "T0821",
        "T0822-D1",
        "T0822",
        "T0823-D1",
        "T0823",
        "T0824-D1",
        "T0824",
        "T0826-D1",
        "T0826-D2",
        "T0826",
        "T0827-D1",
        "T0827-D2",
        "T0827",
        "T0828-D1",
        "T0828-D2",
        "T0828",
        "T0829-D1",
        "T0829",
        "T0830-D1",
        "T0830-D2",
        "T0830",
        "T0831-D1",
        "T0831-D2",
        "T0831",
        "T0832-D1",
        "T0832",
        "T0833-D1",
        "T0833",
        "T0834-D1",
        "T0834-D2",
        "T0834",
        "T0835-D1",
        "T0835",
        "T0836-D1",
        "T0836",
        "T0837-D1",
        "T0837",
        "T0838-D1",
        "T0838",
        "T0839-D1",
        "T0839",
        "T0840-D1",
        "T0840-D2",
        "T0840",
        "T0841",
        "T0843-D1",
        "T0843",
        "T0845-D1",
        "T0845-D2",
        "T0845",
        "T0847-D1",
        "T0847",
        "T0848-D1",
        "T0848-D2",
        "T0848",
        "T0849-D1",
        "T0849",
        "T0851-D1",
        "T0851",
        "T0852-D1",
        "T0852-D2",
        "T0852",
        "T0853-D1",
        "T0853-D2",
        "T0853",
        "T0854-D1",
        "T0854-D2",
        "T0854",
        "T0855-D1",
        "T0855",
        "T0856-D1",
        "T0856",
        "T0857-D1",
        "T0857",
        "T0858-D1",
        "T0858"
      ],
      700
    ),
    "CASP10": (
      "https://predictioncenter.org/download_area/CASP10/results_LGA_sda/",
      [
        "T0644-D1",
        "T0644",
        "T0645-D1",
        "T0645",
        "T0648-D1",
        "T0648",
        "T0649-D1",
        "T0649",
        "T0650-D1",
        "T0650",
        "T0651-D1",
        "T0651-D2",
        "T0651",
        "T0652-D1",
        "T0652-D2",
        "T0652",
        "T0653-D1",
        "T0653",
        "T0654-D1",
        "T0654",
        "T0655-D1",
        "T0655",
        "T0657-D1",
        "T0657",
        "T0658-D1",
        "T0658-D2",
        "T0658",
        "T0659-D1",
        "T0659",
        "T0661-D1",
        "T0661",
        "T0662-D1",
        "T0662",
        "T0663-D1",
        "T0663-D2",
        "T0663",
        "T0664-D1",
        "T0664",
        "T0666-D1",
        "T0666",
        "T0667-D1",
        "T0667",
        "T0668-D1",
        "T0668",
        "T0669-D1",
        "T0669",
        "T0671-D1",
        "T0671-D2",
        "T0671",
        "T0672-D1",
        "T0672",
        "T0673-D1",
        "T0673",
        "T0674-D1",
        "T0674-D2",
        "T0674",
        "T0675-D1",
        "T0675-D2",
        "T0675",
        "T0676-D1",
        "T0676",
        "T0677-D1",
        "T0677-D2",
        "T0678-D1",
        "T0678",
        "T0679-D1",
        "T0679",
        "T0680-D1",
        "T0680",
        "T0681-D1",
        "T0681",
        "T0682-D1",
        "T0682",
        "T0683-D1",
        "T0683",
        "T0684-D1",
        "T0684-D2",
        "T0684",
        "T0685-D1",
        "T0685-D2",
        "T0685",
        "T0686-D1",
        "T0686-D2",
        "T0686",
        "T0687-D1",
        "T0687",
        "T0688-D1",
        "T0688",
        "T0689-D1",
        "T0689",
        "T0690-D1",
        "T0690-D2",
        "T0690",
        "T0691-D1",
        "T0691",
        "T0692-D1",
        "T0692",
        "T0693-D1",
        "T0693-D2",
        "T0693",
        "T0694-D1",
        "T0694",
        "T0695-D1",
        "T0695",
        "T0696-D1",
        "T0696",
        "T0697-D1",
        "T0697",
        "T0698-D1",
        "T0698",
        "T0699-D1",
        "T0699",
        "T0700-D1",
        "T0700",
        "T0701-D1",
        "T0701",
        "T0702-D1",
        "T0702",
        "T0703-D1",
        "T0703",
        "T0704-D1",
        "T0704",
        "T0705-D1",
        "T0705-D2",
        "T0705",
        "T0706-D9",
        "T0706",
        "T0707-D1",
        "T0707",
        "T0708-D1",
        "T0708",
        "T0709-D1",
        "T0709",
        "T0710-D1",
        "T0710",
        "T0711-D1",
        "T0711",
        "T0712-D1",
        "T0712",
        "T0713-D1",
        "T0713-D2",
        "T0713",
        "T0714-D1",
        "T0714",
        "T0715-D1",
        "T0715",
        "T0716-D1",
        "T0716",
        "T0717-D1",
        "T0717-D2",
        "T0717",
        "T0719-D1",
        "T0719-D2",
        "T0719-D3",
        "T0719-D4",
        "T0719-D5",
        "T0719-D6",
        "T0719",
        "T0720-D1",
        "T0720",
        "T0721-D1",
        "T0721",
        "T0724-D1",
        "T0724-D2",
        "T0724",
        "T0726-D1",
        "T0726-D2",
        "T0726-D3",
        "T0726",
        "T0731-D1",
        "T0731",
        "T0732-D1",
        "T0732-D2",
        "T0732",
        "T0733-D1",
        "T0733",
        "T0734-D1",
        "T0734",
        "T0735-D1",
        "T0735-D2",
        "T0735",
        "T0736-D1",
        "T0736",
        "T0737-D1",
        "T0737",
        "T0738-D1",
        "T0738",
        "T0739-D1",
        "T0739-D2",
        "T0739-D3",
        "T0739-D4",
        "T0739",
        "T0740-D1",
        "T0740",
        "T0741-D1",
        "T0741",
        "T0742-D1",
        "T0742",
        "T0743-D1",
        "T0743",
        "T0744-D1",
        "T0744",
        "T0746-D1",
        "T0746",
        "T0747-D9",
        "T0747",
        "T0749-D1",
        "T0749",
        "T0750-D1",
        "T0750",
        "T0752-D1",
        "T0752",
        "T0753-D1",
        "T0753",
        "T0755-D1",
        "T0755",
        "T0756-D1",
        "T0756-D2",
        "T0756",
        "T0757-D1",
        "T0757",
        "T0758-D1",
        "T0758"
      ],
      700
    ),
    "CASP9": (
      "https://predictioncenter.org/download_area/CASP9/results_LGA_sda/",
      [
        "T0515-D1", "T0515", "T0516-D1", "T0516", "T0517-D1", "T0517",
        "T0518-D1", "T0518", "T0520-D1", "T0520", "T0521-D1", "T0521-D2",
        "T0521", "T0522-D1", "T0522", "T0523-D1", "T0523", "T0524-D1",
        "T0524", "T0525-D1", "T0525", "T0526-D1", "T0526", "T0527-D1",
        "T0527", "T0528-D1", "T0528-D2", "T0528", "T0529-D1", "T0529-D2",
        "T0529", "T0530-D1", "T0530", "T0531-D1", "T0531", "T0532-D1",
        "T0532", "T0533-D1", "T0533-D2", "T0533", "T0534-D1", "T0534-D2",
        "T0534", "T0536-D1", "T0536", "T0537-D1", "T0537-D2", "T0537",
        "T0538-D1", "T0538", "T0539-D1", "T0539", "T0540-D1", "T0540",
        "T0541-D1", "T0541", "T0542-D1", "T0542-D2", "T0542", "T0543-D1",
        "T0543-D2", "T0543-D3", "T0543-D4", "T0543", "T0544-D1", "T0544",
        "T0545-D1", "T0545", "T0547-D1", "T0547-D2", "T0547-D3", "T0547-D4",
        "T0547", "T0548-D1", "T0548-D2", "T0548", "T0549", "T0550-D1",
        "T0550-D2", "T0550", "T0551-D1", "T0551", "T0552-D1", "T0552",
        "T0553-D1", "T0553-D2", "T0553", "T0555-D1", "T0555", "T0557-D1",
        "T0557", "T0558-D1", "T0558", "T0559-D1", "T0559", "T0560-D1",
        "T0560", "T0561-D1", "T0561", "T0562-D1", "T0562", "T0563-D1",
        "T0563", "T0564-D1", "T0564", "T0565-D1", "T0565", "T0566-D1",
        "T0566", "T0567-D1", "T0567", "T0568-D1", "T0568", "T0569-D1",
        "T0569", "T0570-D1", "T0570", "T0571-D1", "T0571-D2", "T0571",
        "T0572-D1", "T0572", "T0573-D1", "T0573", "T0574-D1", "T0574",
        "T0575-D1", "T0575-D2", "T0575", "T0576-D1", "T0576", "T0578-D1",
        "T0578", "T0579-D1", "T0579-D2", "T0579", "T0580-D1", "T0580",
        "T0581-D1", "T0581", "T0582-D1", "T0582-D2", "T0582", "T0584-D1",
        "T0584", "T0585-D1", "T0585", "T0586-D1", "T0586-D2", "T0586",
        "T0588-D1", "T0588", "T0589-D1", "T0589-D2", "T0589-D3", "T0589",
        "T0590-D1", "T0590", "T0591-D1", "T0591", "T0592-D1", "T0592",
        "T0593-D1", "T0593", "T0594-D1", "T0594", "T0596-D1", "T0596-D2",
        "T0596", "T0597-D1", "T0597", "T0598-D1", "T0598", "T0599-D1",
        "T0599", "T0600-D1", "T0600-D2", "T0600", "T0601-D1", "T0601",
        "T0602-D1", "T0602", "T0603-D1", "T0603", "T0604-D1", "T0604-D2",
        "T0604-D3", "T0604", "T0605-D1", "T0605", "T0606-D1", "T0606",
        "T0607-D1", "T0607", "T0608-D1", "T0608-D2", "T0608", "T0609-D1",
        "T0609", "T0610-D1", "T0610", "T0611-D1", "T0611-D2", "T0611",
        "T0612-D1", "T0612", "T0613-D1", "T0613", "T0614-D1", "T0614",
        "T0615-D1", "T0615", "T0616-D1", "T0616", "T0617-D1", "T0617",
        "T0618-D1", "T0618", "T0619-D1", "T0619", "T0620-D1", "T0620",
        "T0621-D1", "T0621", "T0622-D1", "T0622", "T0623-D1", "T0623",
        "T0624-D1", "T0624", "T0625-D1", "T0625", "T0626-D1", "T0626",
        "T0627-D1", "T0627", "T0628-D1", "T0628-D2", "T0628", "T0629-D1",
        "T0629-D2", "T0629", "T0630-D1", "T0630", "T0632-D1", "T0632",
        "T0634-D1", "T0634", "T0635-D1", "T0635", "T0636-D1", "T0636",
        "T0637-D1", "T0637", "T0638-D1", "T0638", "T0639-D1", "T0639",
        "T0640-D1", "T0640", "T0641-D1", "T0641", "T0643-D1", "T0643"
      ],
      700
    ),
    "CASP8": (
      "https://predictioncenter.org/download_area/CASP8/results_sda/",
      [
        "T0387", "T0388-D1", "T0388", "T0389-D1", "T0389", "T0390-D1",
        "T0390", "T0391-D1", "T0391", "T0392-D1", "T0392", "T0393-D1",
        "T0393-D2", "T0393", "T0394-D1", "T0394", "T0395-D1", "T0395",
        "T0396-D1", "T0396", "T0397-D1", "T0397-D2", "T0397", "T0398-D1",
        "T0398-D2", "T0398", "T0399-D1", "T0399", "T0400-D1", "T0400",
        "T0401-D1", "T0401", "T0402-D1", "T0402", "T0404-D1", "T0404",
        "T0405-D1", "T0405-D2", "T0405", "T0406-D1", "T0406", "T0407-D1",
        "T0407-D2", "T0407", "T0408-D1", "T0408", "T0409-D1", "T0409-D9",
        "T0409", "T0410", "T0411-D1", "T0411", "T0412-D1", "T0412",
        "T0413-D1", "T0413", "T0414-D1", "T0414", "T0415-D1", "T0415",
        "T0416-D1", "T0416-D2", "T0416", "T0417-D1", "T0417", "T0418-D1",
        "T0418-D2", "T0418", "T0419-D1", "T0419-D2", "T0419", "T0420-D1",
        "T0420", "T0421-D1", "T0421-D9", "T0421", "T0422-D1", "T0422-D2",
        "T0422", "T0423-D1", "T0423", "T0424-D1", "T0424-D2", "T0424-D3",
        "T0424", "T0425-D1", "T0425", "T0426-D1", "T0426", "T0427-D1",
        "T0427-D2", "T0427", "T0428-D1", "T0428", "T0429-D1", "T0429-D2",
        "T0429", "T0430-D1", "T0430-D2", "T0430", "T0431-D1", "T0431-D2",
        "T0431", "T0432-D1", "T0432", "T0433-D1", "T0433", "T0434-D1",
        "T0434", "T0435-D1", "T0435", "T0436-D1", "T0436", "T0437-D1",
        "T0437-D9", "T0437", "T0438-D1", "T0438-D2", "T0438", "T0440-D1",
        "T0440", "T0441-D1", "T0441-D2", "T0441", "T0442-D1", "T0442-D2",
        "T0442", "T0443-D1", "T0443-D2", "T0443-D3", "T0443", "T0444-D1",
        "T0444", "T0445-D1", "T0445-D2", "T0445", "T0446-D1", "T0446-D2",
        "T0446", "T0447-D1", "T0447", "T0448-D1", "T0448", "T0449-D1",
        "T0449", "T0450-D1", "T0450", "T0451-D1", "T0451", "T0452-D1",
        "T0452-D2", "T0452", "T0453-D1", "T0453", "T0454-D1", "T0454-D2",
        "T0454", "T0455-D1", "T0455", "T0456-D1", "T0456-D2", "T0456",
        "T0457-D1", "T0457-D2", "T0457", "T0458-D1", "T0458", "T0459-D1",
        "T0459", "T0460-D1", "T0460-D9", "T0460", "T0461-D1", "T0461",
        "T0462-D1", "T0462-D2", "T0462-D8", "T0462-D9", "T0462", "T0463-D1",
        "T0463", "T0464-D1", "T0464", "T0465-D1", "T0465", "T0466-D1",
        "T0466-D9", "T0466", "T0467-D1", "T0467-D9", "T0468-D1", "T0468-D9",
        "T0468", "T0469-D1", "T0469", "T0470-D1", "T0470-D2", "T0470",
        "T0471-D1", "T0471", "T0472-D1", "T0472-D2", "T0472", "T0473-D1",
        "T0473", "T0474-D1", "T0474-D9", "T0474", "T0475-D1", "T0475",
        "T0476-D1", "T0476-D9", "T0476", "T0477-D1", "T0477", "T0478-D1",
        "T0478-D2", "T0478", "T0479-D1", "T0479", "T0480-D1", "T0480-D9",
        "T0480", "T0481-D1", "T0481", "T0482-D1", "T0482-D9", "T0482",
        "T0483-D1", "T0483", "T0485-D1", "T0485", "T0486-D1", "T0486",
        "T0487-D1", "T0487-D2", "T0487-D3", "T0487-D4", "T0487-D5", "T0487",
        "T0488-D1", "T0488", "T0489-D1", "T0489", "T0490-D1", "T0490",
        "T0491-D1", "T0491", "T0492-D1", "T0492-D9", "T0492", "T0493-D1",
        "T0493", "T0494-D1", "T0494", "T0495-D1", "T0495", "T0496-D1",
        "T0496-D2", "T0496", "T0497-D1", "T0497", "T0498-D1", "T0498",
        "T0499-D1", "T0499", "T0501-D1", "T0501-D2", "T0501", "T0502-D1",
        "T0502", "T0503-D1", "T0503", "T0504-D1", "T0504-D2", "T0504-D3",
        "T0504", "T0505-D1", "T0505-D2", "T0505", "T0506-D1", "T0506-D2",
        "T0506", "T0507-D1", "T0507", "T0508-D1", "T0508", "T0509-D1",
        "T0509", "T0510-D1", "T0510-D2", "T0510-D3", "T0510", "T0511-D1",
        "T0511", "T0512-D1", "T0512", "T0513-D1", "T0513-D2", "T0513",
        "T0514-D1", "T0514"
      ],
      700
    ),
  }
  for tmp_key in tmp_all_casps_targets.keys():
    tmp_casp_winners[tmp_key] = extract_casp_winner(
      tmp_key,
      tmp_all_casps_targets[tmp_key][0],
      tmp_all_casps_targets[tmp_key][1],
      tmp_all_casps_targets[tmp_key][2],
    )

  end_time = time.time()
  print(f"The process took: {(end_time - start_time) / 60} minutes.")
  print(tmp_casp_winners)
  # Specify the CSV file name
  csv_file = 'CASP_extracted_data.csv'
  # Writing to the CSV file
  with open(csv_file, mode='w', newline='') as file:
    writer = csv.writer(file)

    # Write the header
    writer.writerow(['CASP', 'GroupName', 'GDT_TS', 'RMSD'])

    # Write the data
    for casp, values in tmp_casp_winners.items():
      writer.writerow([casp] + list(values))

  print(f'Data written to {csv_file}')
